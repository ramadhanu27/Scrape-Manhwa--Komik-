<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Reader - ARManhwa</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow-x: hidden;
        }
        
        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }
        .top-bar.hidden {
            transform: translateY(-100%);
        }
        .back-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
        }
        .chapter-info {
            flex: 1;
            text-align: center;
            padding: 0 20px;
        }
        .chapter-title {
            font-weight: 600;
            font-size: 1em;
            color: #fff;
        }
        .chapter-subtitle {
            font-size: 0.85em;
            color: #999;
            margin-top: 2px;
        }
        .home-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.3em;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        /* Reader Container */
        .reader-container {
            max-width: 900px;
            margin: 60px auto 0;
            padding: 0;
        }
        
        /* Images Container */
        .images-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: #000;
        }
        .page-image {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Floating Controls */
        .floating-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
            transition: opacity 0.3s, transform 0.3s;
        }
        .floating-controls.hidden {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            pointer-events: none;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .control-btn:disabled:hover {
            transform: none;
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* Scroll buttons */
        .scroll-btn {
            position: fixed;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s;
        }
        .scroll-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .scroll-up {
            top: 80px;
        }
        .scroll-down {
            bottom: 30px;
        }
        
        /* Stop Auto-Scroll Button */
        .stop-scroll-btn {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(255, 107, 107, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            z-index: 1001;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5);
            animation: pulse 2s infinite;
        }
        .stop-scroll-btn.show {
            display: flex;
        }
        .stop-scroll-btn:hover {
            background: rgba(255, 107, 107, 1);
            transform: translateX(-50%) scale(1.05);
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5);
            }
            50% {
                box-shadow: 0 5px 30px rgba(255, 107, 107, 0.8);
            }
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 100px 20px;
            font-size: 1.5em;
            color: #999;
        }
        
        .error {
            text-align: center;
            padding: 100px 20px;
            color: #ff6b6b;
        }
        
        /* Hide controls on scroll */
        body.reading .top-bar,
        body.reading .floating-controls {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
            transition: right 0.3s;
            overflow-y: auto;
            padding: 20px;
        }
        .side-menu.open {
            right: 0;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .menu-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        .close-menu {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        /* Auto Scroll Section */
        .auto-scroll-section {
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .auto-scroll-section h3 {
            font-size: 1em;
            margin-bottom: 15px;
            color: #ff6b6b;
        }
        .scroll-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .scroll-btn-group {
            display: flex;
            gap: 10px;
        }
        .scroll-action-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .scroll-action-btn:hover {
            background: #ff6b6b;
        }
        .scroll-action-btn.active {
            background: #ff6b6b;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .speed-control label {
            font-size: 0.9em;
            color: #999;
        }
        .speed-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff6b6b;
            cursor: pointer;
        }
        .speed-value {
            font-weight: bold;
            color: #ff6b6b;
            min-width: 30px;
        }
        
        /* Chapter List */
        .chapter-list-section {
            margin-top: 20px;
        }
        .chapter-list-section h3 {
            font-size: 1em;
            margin-bottom: 15px;
            color: #ff6b6b;
        }
        .chapter-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chapter-item {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 107, 107, 0.5);
        }
        .chapter-item.active {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }
        .chapter-name {
            font-weight: 600;
        }
        .chapter-pages {
            font-size: 0.85em;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .side-menu {
                width: 100%;
                right: -100%;
            }
            .reader-container {
                margin-top: 50px;
            }
            .floating-controls {
                bottom: 20px;
                gap: 10px;
            }
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 1em;
            }
            .scroll-btn {
                width: 40px;
                height: 40px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar" id="top-bar">
        <button class="back-btn" onclick="goBack()">←</button>
        <div class="chapter-info">
            <div class="chapter-title" id="nav-title">Loading...</div>
            <div class="chapter-subtitle" id="nav-subtitle">0 pages</div>
        </div>
        <button class="home-btn" onclick="goHome()">🏠</button>
    </div>

    <!-- Reader Container -->
    <div class="reader-container">
        <div id="images-container" class="images-container">
            <div class="loading">⏳ Loading chapter...</div>
        </div>
    </div>

    <!-- Floating Controls -->
    <div class="floating-controls" id="floating-controls">
        <button class="control-btn" id="prev-btn" onclick="prevChapter()" title="Previous Chapter">←</button>
        <button class="control-btn" onclick="toggleFullscreen()" title="Settings">⚙️</button>
        <button class="control-btn" onclick="toggleMenu()" title="Menu">☰</button>
        <button class="control-btn" onclick="window.location.reload()" title="Reload">↻</button>
        <button class="control-btn" id="next-btn" onclick="nextChapter()" title="Next Chapter">→</button>
    </div>

    <!-- Scroll Buttons -->
    <button class="scroll-btn scroll-up" onclick="scrollToTop()">↑</button>
    <button class="scroll-btn scroll-down" onclick="scrollToBottom()">↓</button>

    <!-- Stop Auto-Scroll Button -->
    <button class="stop-scroll-btn" id="stop-scroll-btn" onclick="stopAutoScroll()">
        ⏸ Stop Auto-Scroll
    </button>

    <!-- Side Menu -->
    <div class="side-menu" id="side-menu">
        <div class="menu-header">
            <div class="menu-title">⚙️ Settings</div>
            <button class="close-menu" onclick="toggleMenu()">×</button>
        </div>

        <!-- Reading Mode Section -->
        <div class="auto-scroll-section">
            <h3>📖 Reading Mode</h3>
            <div class="scroll-controls">
                <div class="scroll-btn-group">
                    <button class="scroll-action-btn" id="vertical-mode" onclick="setReadingMode('vertical')">⬇️ Vertical</button>
                    <button class="scroll-action-btn" id="horizontal-mode" onclick="setReadingMode('horizontal')">➡️ Horizontal</button>
                </div>
            </div>
        </div>

        <!-- Auto Scroll Section -->
        <div class="auto-scroll-section">
            <h3>🔄 Auto Scroll</h3>
            <div class="scroll-controls">
                <div class="scroll-btn-group">
                    <button class="scroll-action-btn" id="start-scroll-btn" onclick="startAutoScroll()">▶ Start</button>
                    <button class="scroll-action-btn" onclick="stopAutoScroll()">⏸ Stop</button>
                </div>
                <div class="speed-control">
                    <label>Speed:</label>
                    <input type="range" class="speed-slider" id="speed-slider" min="1" max="10" value="3" oninput="updateSpeed(this.value)">
                    <span class="speed-value" id="speed-value">3</span>
                </div>
            </div>
        </div>

        <!-- Image Settings -->
        <div class="auto-scroll-section">
            <h3>🖼️ Image Settings</h3>
            <div class="scroll-controls">
                <div class="speed-control">
                    <label>Width:</label>
                    <input type="range" class="speed-slider" id="width-slider" min="50" max="100" value="100" oninput="updateImageWidth(this.value)">
                    <span class="speed-value" id="width-value">100%</span>
                </div>
                <div class="scroll-btn-group">
                    <button class="scroll-action-btn" onclick="toggleImageFit()">📐 Fit Screen</button>
                    <button class="scroll-action-btn" onclick="resetImageSettings()">🔄 Reset</button>
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="auto-scroll-section">
            <h3>📊 Progress</h3>
            <div style="color: #999; font-size: 0.9em;">
                <div style="margin-bottom: 8px;">Page: <span id="current-page">0</span> / <span id="total-pages">0</span></div>
                <div style="margin-bottom: 8px;">Progress: <span id="progress-percent">0%</span></div>
                <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                    <div id="progress-bar" style="background: #ff6b6b; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>

        <!-- Chapter List Section -->
        <div class="chapter-list-section">
            <h3>📚 Chapters (<span id="chapter-count">0</span>)</h3>
            <div class="chapter-list" id="chapter-list">
                <div style="text-align: center; color: #999; padding: 20px;">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const manhwaSlug = urlParams.get('slug');
        const chapterNumber = urlParams.get('chapter');

        let allChapters = [];
        let currentChapterIndex = -1;
        let currentChapter = null;

        // Navigation functions
        function goBack() {
            window.location.href = `detail-lite.html?slug=${manhwaSlug}`;
        }
        
        function goHome() {
            window.location.href = 'standalone.html';
        }
        
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function toggleControls() {
            document.getElementById('floating-controls').classList.toggle('hidden');
            document.getElementById('top-bar').classList.toggle('hidden');
        }
        
        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('open');
        }
        
        // Auto Scroll
        let autoScrollInterval = null;
        let scrollSpeed = 3;
        
        function startAutoScroll() {
            if (autoScrollInterval) return;
            
            document.getElementById('start-scroll-btn').classList.add('active');
            document.getElementById('stop-scroll-btn').classList.add('show');
            
            autoScrollInterval = setInterval(() => {
                window.scrollBy(0, scrollSpeed);
                
                // Stop at bottom
                if ((window.innerHeight + window.scrollY) >= document.body.scrollHeight) {
                    stopAutoScroll();
                }
            }, 50);
        }
        
        function stopAutoScroll() {
            if (autoScrollInterval) {
                clearInterval(autoScrollInterval);
                autoScrollInterval = null;
                document.getElementById('start-scroll-btn').classList.remove('active');
                document.getElementById('stop-scroll-btn').classList.remove('show');
            }
        }
        
        function updateSpeed(value) {
            scrollSpeed = parseInt(value);
            document.getElementById('speed-value').textContent = value;
        }
        
        // Render chapter list
        function renderChapterList() {
            const container = document.getElementById('chapter-list');
            document.getElementById('chapter-count').textContent = allChapters.length;
            
            container.innerHTML = allChapters.map((ch, index) => `
                <div class="chapter-item ${ch.number === chapterNumber ? 'active' : ''}" 
                     onclick="goToChapter('${ch.number}')">
                    <div class="chapter-name">${ch.title || 'Chapter ' + ch.number}</div>
                    <div class="chapter-pages">${ch.totalPages || 0}p</div>
                </div>
            `).join('');
        }
        
        function goToChapter(number) {
            window.location.href = `reader.html?slug=${manhwaSlug}&chapter=${number}`;
        }
        
        // Reading Mode
        let readingMode = 'vertical';
        
        function setReadingMode(mode) {
            readingMode = mode;
            const container = document.querySelector('.images-container');
            
            if (mode === 'horizontal') {
                container.style.flexDirection = 'row';
                container.style.overflowX = 'auto';
                container.style.scrollSnapType = 'x mandatory';
                document.querySelectorAll('.page-image').forEach(img => {
                    img.style.scrollSnapAlign = 'center';
                    img.style.minWidth = '100%';
                });
                document.getElementById('horizontal-mode').classList.add('active');
                document.getElementById('vertical-mode').classList.remove('active');
            } else {
                container.style.flexDirection = 'column';
                container.style.overflowX = 'visible';
                container.style.scrollSnapType = 'none';
                document.querySelectorAll('.page-image').forEach(img => {
                    img.style.scrollSnapAlign = 'unset';
                    img.style.minWidth = 'unset';
                });
                document.getElementById('vertical-mode').classList.add('active');
                document.getElementById('horizontal-mode').classList.remove('active');
            }
        }
        
        // Image Settings
        function updateImageWidth(value) {
            document.getElementById('width-value').textContent = value + '%';
            document.querySelectorAll('.page-image').forEach(img => {
                img.style.width = value + '%';
            });
        }
        
        function toggleImageFit() {
            const images = document.querySelectorAll('.page-image');
            const currentHeight = images[0]?.style.height;
            
            if (currentHeight === '100vh') {
                images.forEach(img => {
                    img.style.height = 'auto';
                    img.style.objectFit = 'contain';
                });
            } else {
                images.forEach(img => {
                    img.style.height = '100vh';
                    img.style.objectFit = 'contain';
                });
            }
        }
        
        function resetImageSettings() {
            document.getElementById('width-slider').value = 100;
            updateImageWidth(100);
            document.querySelectorAll('.page-image').forEach(img => {
                img.style.height = 'auto';
                img.style.objectFit = 'contain';
            });
        }
        
        // Progress Tracking
        function updateProgress() {
            const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
            const images = document.querySelectorAll('.page-image');
            let currentPage = 0;
            
            images.forEach((img, index) => {
                const rect = img.getBoundingClientRect();
                if (rect.top < window.innerHeight / 2) {
                    currentPage = index + 1;
                }
            });
            
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = images.length;
            document.getElementById('progress-percent').textContent = Math.round(scrollPercent) + '%';
            document.getElementById('progress-bar').style.width = scrollPercent + '%';
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Space = toggle auto-scroll
            if (e.code === 'Space') {
                e.preventDefault();
                if (autoScrollInterval) {
                    stopAutoScroll();
                } else {
                    startAutoScroll();
                }
            }
            // M = toggle menu
            if (e.code === 'KeyM') {
                toggleMenu();
            }
            // F = fullscreen
            if (e.code === 'KeyF') {
                toggleFullscreen();
            }
            // + = increase speed
            if (e.code === 'Equal' || e.code === 'NumpadAdd') {
                const slider = document.getElementById('speed-slider');
                const newValue = Math.min(10, parseInt(slider.value) + 1);
                slider.value = newValue;
                updateSpeed(newValue);
            }
            // - = decrease speed
            if (e.code === 'Minus' || e.code === 'NumpadSubtract') {
                const slider = document.getElementById('speed-slider');
                const newValue = Math.max(1, parseInt(slider.value) - 1);
                slider.value = newValue;
                updateSpeed(newValue);
            }
        });
        
        // Auto-hide controls on scroll
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            document.body.classList.add('reading');
            updateProgress(); // Update progress on scroll
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                document.body.classList.remove('reading');
            }, 1000);
        });
        
        // Initialize reading mode
        document.getElementById('vertical-mode').classList.add('active');

        // Load chapter data
        async function loadChapter() {
            if (!manhwaSlug || !chapterNumber) {
                showError('Invalid chapter URL');
                return;
            }

            try {
                // Load chapter list
                const response = await fetch(`../chapters/manhwaindo/${manhwaSlug}.json`);
                if (!response.ok) {
                    throw new Error('Chapter data not found');
                }

                const data = await response.json();
                allChapters = data.chapters || [];
                
                // Find current chapter
                currentChapterIndex = allChapters.findIndex(ch => ch.number === chapterNumber);
                if (currentChapterIndex === -1) {
                    throw new Error('Chapter not found');
                }

                currentChapter = allChapters[currentChapterIndex];

                // Display chapter
                displayChapter(data.manhwaTitle, currentChapter);

            } catch (error) {
                showError(error.message);
            }
        }

        function displayChapter(manhwaTitle, chapter) {
            // Update titles
            document.getElementById('nav-title').textContent = `${manhwaTitle} - Chapter ${chapter.number}`;
            document.getElementById('nav-subtitle').textContent = (chapter.images?.length || 0) + ' pages';
            document.title = `${manhwaTitle} - Chapter ${chapter.number}`;

            // Display images
            const container = document.getElementById('images-container');
            if (!chapter.images || chapter.images.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <h2>📭 No images found</h2>
                        <p>Chapter belum di-download atau path salah</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chapter.images.map((img, index) => `
                <img class="page-image" 
                     src="../${img.localPath}" 
                     alt="Page ${img.page}"
                     loading="lazy"
                     onerror="this.style.display='none'">
            `).join('');

            // Update navigation buttons
            updateNavButtons();
            
            // Render chapter list in menu
            renderChapterList();
        }

        function updateNavButtons() {
            const hasPrev = currentChapterIndex > 0;
            const hasNext = currentChapterIndex < allChapters.length - 1;

            document.getElementById('prev-btn').disabled = !hasPrev;
            document.getElementById('next-btn').disabled = !hasNext;
        }

        function prevChapter() {
            if (currentChapterIndex > 0) {
                const prevChapter = allChapters[currentChapterIndex - 1];
                window.location.href = `reader.html?slug=${manhwaSlug}&chapter=${prevChapter.number}`;
            }
        }

        function nextChapter() {
            if (currentChapterIndex < allChapters.length - 1) {
                const nextChapter = allChapters[currentChapterIndex + 1];
                window.location.href = `reader.html?slug=${manhwaSlug}&chapter=${nextChapter.number}`;
            }
        }

        function showError(message) {
            document.getElementById('images-container').innerHTML = `
                <div class="error">
                    <h2>❌ Error</h2>
                    <p>${message}</p>
                    <br>
                    <a href="detail.html?slug=${manhwaSlug}" class="back-btn">← Back to Detail</a>
                </div>
            `;
        }

        // Load chapter on page load
        loadChapter();

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevChapter();
            if (e.key === 'ArrowRight') nextChapter();
        });
    </script>
</body>
</html>
